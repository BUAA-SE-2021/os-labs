<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Project 1: Threads #  需要提交代码和文档。代码即为包含了 pintos/src 的源代码，文档则是在本网站 Resources 区“实验文档模板”和“Project 1 DesignDoc 模板”的整合版本，云平台上可下载。请将其整合导出为一个 PDF 文件，命名为 p1-组长学号-组长姓名.pdf ，并与代码文件打包为 Zip，提交至云平台。
提交的目录结构为：
p1-组长学号-组长姓名 ├── pintos ├── src ...... ├── p1-组长学号-组长姓名.pdf 本次实验的 DDL 是 2021 年 11 月 11 日晚 23 时。
实验背景知识 #  Pintos 简介 #  Pintos 是一个小型的操作系统，其运行在 x86 硬件模拟器 bochs 之上。其已经实现了一个功能较少的操作系统，我们要做的事情就是给这个操作系统添加功能。
 Pintos 结构图如上所示。和市面上常见的操作系统类似，Pintos 将整个体系分为了用户态和内核态，用户态的程序通过系统调用获得内核的服务。其操作系统内核主要分为进程管理、内存管理、文件系统、设备驱动程序等四个部分。本次实验所涉及到的主要是进程管理的部分，同学们需要根据需求实现特定的进程调度方案。
Pintos 目录结构 #  本节将主要给大家介绍 Pintos 中比较重要的几个文件夹。
在整个 Pintos 实验课中，我们要修改的代码都在 src 目录下。Project 1 的实验中，我们所要修改的文件主要集中在 src/threads 和 src/devices 这两个目录中，由于具体实现方式不同，有的同学也会有可能修改到少量其他目录中的文件。">
<meta name=theme-color content="#FFFFFF">
<meta name=color-scheme content="light dark"><meta property="og:title" content="Project 1">
<meta property="og:description" content="Project 1: Threads #  需要提交代码和文档。代码即为包含了 pintos/src 的源代码，文档则是在本网站 Resources 区“实验文档模板”和“Project 1 DesignDoc 模板”的整合版本，云平台上可下载。请将其整合导出为一个 PDF 文件，命名为 p1-组长学号-组长姓名.pdf ，并与代码文件打包为 Zip，提交至云平台。
提交的目录结构为：
p1-组长学号-组长姓名 ├── pintos ├── src ...... ├── p1-组长学号-组长姓名.pdf 本次实验的 DDL 是 2021 年 11 月 11 日晚 23 时。
实验背景知识 #  Pintos 简介 #  Pintos 是一个小型的操作系统，其运行在 x86 硬件模拟器 bochs 之上。其已经实现了一个功能较少的操作系统，我们要做的事情就是给这个操作系统添加功能。
 Pintos 结构图如上所示。和市面上常见的操作系统类似，Pintos 将整个体系分为了用户态和内核态，用户态的程序通过系统调用获得内核的服务。其操作系统内核主要分为进程管理、内存管理、文件系统、设备驱动程序等四个部分。本次实验所涉及到的主要是进程管理的部分，同学们需要根据需求实现特定的进程调度方案。
Pintos 目录结构 #  本节将主要给大家介绍 Pintos 中比较重要的几个文件夹。
在整个 Pintos 实验课中，我们要修改的代码都在 src 目录下。Project 1 的实验中，我们所要修改的文件主要集中在 src/threads 和 src/devices 这两个目录中，由于具体实现方式不同，有的同学也会有可能修改到少量其他目录中的文件。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://buaa-se-2021.github.io/os-labs/docs/table-of-contents/p1/"><meta property="article:section" content="docs">
<meta property="article:modified_time" content="2021-10-14T14:26:36+08:00">
<title>Project 1 | OS Pintos Labs</title>
<link rel=manifest href=/os-labs/manifest.json>
<link rel=icon href=/os-labs/favicon.png type=image/x-icon>
<link rel=stylesheet href=/os-labs/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css integrity="sha256-RhgbyTN1upMgJudTs3xA5v+LsWqe93DHi8xmPkV3sbo=" crossorigin=anonymous>
<script defer src=/os-labs/flexsearch.min.js></script>
<script defer src=/os-labs/en.search.min.249b7c700c7553c337f01de796f5df16b1b882c736d772673b6cd43c5e78b88a.js integrity="sha256-JJt8cAx1U8M38B3nlvXfFrG4gsc213JnO2zUPF54uIo=" crossorigin=anonymous></script>
<script defer src=/os-labs/sw.min.f3b6af0beade35f9c86f5d5b080c54bb4c91287aa795367fa753608e508ce5e4.js integrity="sha256-87avC+reNfnIb11bCAxUu0yRKHqnlTZ/p1NgjlCM5eQ=" crossorigin=anonymous></script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<div class=book-menu-content>
<nav>
<h2 class=book-brand>
<a class="flex align-center" href=/os-labs/><span>OS Pintos Labs</span>
</a>
</h2>
<div class=book-search>
<input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/>
<div class="book-search-spinner hidden"></div>
<ul id=book-search-results></ul>
</div>
<ul>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/table-of-contents/>Table of Contents</a>
<ul>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/table-of-contents/ps0/>Problem Set 0</a>
</li>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/table-of-contents/p1/ class=active>Project 1</a>
</li>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/table-of-contents/p2/>Project 2</a>
</li>
</ul>
</li>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/resources/>Resources</a>
<ul>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/resources/weekly-meeting-report/>周例会报告模板</a>
</li>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/resources/install-pintos/>Pintos 环境搭建</a>
</li>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/resources/doc-template/>实验文档模板</a>
</li>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/resources/project01-design-doc/>Project 1 DesignDoc 模板</a>
</li>
<li>
<a href=https://buaa-se-2021.github.io/os-labs/docs/resources/project02-design-doc/>Project 2 DesignDoc 模板</a>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<a href=https://github.com/BUAA-SE-2021/os-labs target=_blank rel=noopener>
Github
</a>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</div>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/os-labs/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>Project 1</strong>
<label for=toc-control>
<img src=/os-labs/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#project-1-threads>Project 1: Threads</a>
<ul>
<li><a href=#实验背景知识>实验背景知识</a>
<ul>
<li><a href=#pintos-简介>Pintos 简介</a></li>
<li><a href=#pintos-目录结构>Pintos 目录结构</a></li>
<li><a href=#实验运行方式>实验运行方式</a></li>
<li><a href=#常用文件介绍>常用文件介绍</a></li>
</ul>
</li>
<li><a href=#实验介绍>实验介绍</a>
<ul>
<li><a href=#任务一唤醒时钟>任务一：唤醒时钟</a></li>
<li><a href=#任务二优先级调度>任务二：优先级调度</a></li>
<li><a href=#任务三高级调度>任务三：高级调度</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</aside>
</header>
<article class=markdown><h1 id=project-1-threads>
Project 1: Threads
<a class=anchor href=#project-1-threads>#</a>
</h1>
<p>需要提交代码和文档。代码即为包含了 <code>pintos/src</code> 的源代码，文档则是在本网站 Resources 区“实验文档模板”和“Project 1 DesignDoc 模板”的整合版本，云平台上可下载。请将其整合导出为一个 PDF 文件，命名为 <code>p1-组长学号-组长姓名.pdf</code> ，并与代码文件打包为 Zip，提交至云平台。</p>
<p>提交的目录结构为：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>p1-组长学号-组长姓名
   ├── pintos
      ├── src
      ......
   ├── p1-组长学号-组长姓名.pdf
</code></pre></div><p>本次实验的 DDL 是 2021 年 11 月 11 日晚 23 时。</p>
<h2 id=实验背景知识>
实验背景知识
<a class=anchor href=#%e5%ae%9e%e9%aa%8c%e8%83%8c%e6%99%af%e7%9f%a5%e8%af%86>#</a>
</h2>
<h3 id=pintos-简介>
Pintos 简介
<a class=anchor href=#pintos-%e7%ae%80%e4%bb%8b>#</a>
</h3>
<p>Pintos 是一个小型的操作系统，其运行在 x86 硬件模拟器 bochs 之上。其已经实现了一个功能较少的操作系统，我们要做的事情就是给这个操作系统添加功能。</p>
<p>
<img src=https://raw.githubusercontent.com/BUAA-SE-2021/os-labs/main/static/img/pintos-structure.png alt=pintos-structure></p>
<p>Pintos 结构图如上所示。和市面上常见的操作系统类似，Pintos 将整个体系分为了用户态和内核态，用户态的程序通过系统调用获得内核的服务。其操作系统内核主要分为进程管理、内存管理、文件系统、设备驱动程序等四个部分。本次实验所涉及到的主要是进程管理的部分，同学们需要根据需求实现特定的进程调度方案。</p>
<h3 id=pintos-目录结构>
Pintos 目录结构
<a class=anchor href=#pintos-%e7%9b%ae%e5%bd%95%e7%bb%93%e6%9e%84>#</a>
</h3>
<p>本节将主要给大家介绍 Pintos 中比较重要的几个文件夹。</p>
<p>在整个 Pintos 实验课中，我们要修改的代码都在 <code>src</code> 目录下。Project 1 的实验中，我们所要修改的文件主要集中在 <code>src/threads</code> 和 <code>src/devices</code> 这两个目录中，由于具体实现方式不同，有的同学也会有可能修改到少量其他目录中的文件。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>.
├── devices <span style=color:#75715e># 包含一些与硬件交互的内容</span>
├── examples <span style=color:#75715e># 包含 Pintos 对一些常用 Shell 命令的实现</span>
├── filesys <span style=color:#75715e># 包含 Pintos 中对文件系统的实现</span>
├── lib <span style=color:#75715e># 包含 C 语言中的一些标准库</span>
├── LICENSE
├── Make.config
├── Makefile
├── Makefile.build
├── Makefile.kernel
├── Makefile.userprog
├── misc
├── tests <span style=color:#75715e># 包含各实验的测试文件</span>
├── threads <span style=color:#75715e># 包含 Pintos 对于内核线程的实现</span>
├── userprog <span style=color:#75715e># 包含 Pintos 对于用户线程的实现</span>
├── utils
└── vm
<span style=color:#ae81ff>10</span> directories, <span style=color:#ae81ff>6</span> files
</code></pre></div><h3 id=实验运行方式>
实验运行方式
<a class=anchor href=#%e5%ae%9e%e9%aa%8c%e8%bf%90%e8%a1%8c%e6%96%b9%e5%bc%8f>#</a>
</h3>
<p>在实验正式开始前，请同学们修改文件 <code>pintos/src/tests/Make.tests</code> 中的第 55 行</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>TESTCMD <span style=color:#f92672>=</span> pintos -v -k -T <span style=color:#66d9ef>$(</span>TIMEOUT<span style=color:#66d9ef>)</span> <span style=color:#75715e># 修改前</span>
TESTCMD <span style=color:#f92672>=</span> pintos -k -T <span style=color:#66d9ef>$(</span>TIMEOUT<span style=color:#66d9ef>)</span> <span style=color:#75715e># 修改后</span>
</code></pre></div><p>否则，在某些同学的电脑上可能测试无法正常进行。</p>
<p>修改完毕后，在 Project 1 实验中，代码的运行方式为：</p>
<ol>
<li>进入 <code>src/threads</code> 目录</li>
<li>使用 <code>make clean</code> 命令清除上次编译后的信息</li>
<li>使用 <code>make check</code> 命令对文件进行编译并运行，首次运行会得到如图所示的过点信息：</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>pass tests/threads/alarm-single
pass tests/threads/alarm-multiple
FAIL tests/threads/alarm-simultaneous
FAIL tests/threads/alarm-priority
pass tests/threads/alarm-zero
pass tests/threads/alarm-negative
FAIL tests/threads/priority-change
FAIL tests/threads/priority-donate-one
FAIL tests/threads/priority-donate-multiple
FAIL tests/threads/priority-donate-multiple2
FAIL tests/threads/priority-donate-nest
FAIL tests/threads/priority-donate-sema
FAIL tests/threads/priority-donate-lower
FAIL tests/threads/priority-fifo
FAIL tests/threads/priority-preempt
FAIL tests/threads/priority-sema
FAIL tests/threads/priority-condvar
FAIL tests/threads/priority-donate-chain
FAIL tests/threads/mlfqs-load-1
FAIL tests/threads/mlfqs-load-60
FAIL tests/threads/mlfqs-load-avg
FAIL tests/threads/mlfqs-recent-1
pass tests/threads/mlfqs-fair-2
pass tests/threads/mlfqs-fair-20
FAIL tests/threads/mlfqs-nice-2
FAIL tests/threads/mlfqs-nice-10
FAIL tests/threads/mlfqs-block
<span style=color:#ae81ff>21</span> of <span style=color:#ae81ff>27</span> tests failed.
</code></pre></div><h3 id=常用文件介绍>
常用文件介绍
<a class=anchor href=#%e5%b8%b8%e7%94%a8%e6%96%87%e4%bb%b6%e4%bb%8b%e7%bb%8d>#</a>
</h3>
<ol>
<li>在 <code>src/tests/threads</code> 文件夹中，包含了实验一的所有测试文件。</li>
<li><code>make check</code> 之后，<code>src/threads</code> 中会生成一个 <code>build</code> 文件，文件夹 <code>src/threads/build/tests/threads</code> 中包含了程序在每一个测试点的输出。</li>
</ol>
<h2 id=实验介绍>
实验介绍
<a class=anchor href=#%e5%ae%9e%e9%aa%8c%e4%bb%8b%e7%bb%8d>#</a>
</h2>
<p>本次实验一共有三个小任务，本文档将依次对它们进行介绍。
<a href=http://web.stanford.edu/~ouster/cgi-bin/cs140-spring20/pintos/pintos_2.html>实验一文档</a>中有更加详细的介绍，同学们做实验过程中有任何疑问都可以自行查阅官方文档。</p>
<h3 id=任务一唤醒时钟>
任务一：唤醒时钟
<a class=anchor href=#%e4%bb%bb%e5%8a%a1%e4%b8%80%e5%94%a4%e9%86%92%e6%97%b6%e9%92%9f>#</a>
</h3>
<p>这个是本次实验中最为简单的一个任务。在原始的代码实现中，<code>timer_sleep()</code> 函数的实现如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>void</span>
<span style=color:#a6e22e>timer_sleep</span> (<span style=color:#66d9ef>int64_t</span> ticks)
{
  <span style=color:#66d9ef>int64_t</span> start <span style=color:#f92672>=</span> timer_ticks ();
  ASSERT (intr_get_level () <span style=color:#f92672>==</span> INTR_ON);
  <span style=color:#66d9ef>while</span> (timer_elapsed (start) <span style=color:#f92672>&lt;</span> ticks)
    thread_yield ();
}
</code></pre></div><p>由代码最后两行，在原本的代码实现中，<code>timer_sleep()</code> 函数实现的是一个“忙等待”，当线程在调用 <code>timer_sleep()</code> 函数之后，会睡眠 <code>ticks</code> 个单位时间。</p>
<p>根据题意，我们所要做的事便是消除这种忙等待。根据这个要求，可以想到使用时钟中断。在 <code>thread.h</code> 文件中，可以看到，Pintos 线程一共有以下几个状态：</p>
<pre tabindex=0><code>enum thread_status
{
    THREAD_RUNNING,     /* 运行态。 */
    THREAD_READY,       /* 就绪态。 */
    THREAD_BLOCKED,     /* 阻塞态。 */
    THREAD_DYING        /* 销毁态。 */
};
</code></pre><p>因此，线程睡眠时，我们可以将其设置为阻塞态。而睡眠时间结束之后，将其设置为就绪态即可。</p>
<p>在第一个小实验中，涉及到的测试点一共有以下几个：</p>
<table>
<thead>
<tr>
<th>测试点名称</th>
<th>测试内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>alarm-single</td>
<td>测试单个线程能否在规定时间后被唤醒</td>
</tr>
<tr>
<td>alarm-multiple</td>
<td>测试多个线程能否在规定之间后被唤醒</td>
</tr>
<tr>
<td>alarm-simultaneous</td>
<td>创建多个线程，并且在同一个时间进入睡眠状态，每个线程的睡眠时长不同，测试唤醒顺序是否正确。</td>
</tr>
<tr>
<td>alarm-zero</td>
<td>测试睡眠时长为 0 的情况</td>
</tr>
<tr>
<td>alarm-negative</td>
<td>测试睡眠时长为负数的情况</td>
</tr>
</tbody>
</table>
<p><strong>注意点：</strong></p>
<p>需要考虑到睡眠时长为 0 或者负数的情况</p>
<h3 id=任务二优先级调度>
任务二：优先级调度
<a class=anchor href=#%e4%bb%bb%e5%8a%a1%e4%ba%8c%e4%bc%98%e5%85%88%e7%ba%a7%e8%b0%83%e5%ba%a6>#</a>
</h3>
<p>这是本次实验最难的任务，主要包含以下两大部分：实现优先级调度和实现优先级捐赠。</p>
<h4 id=实现优先级调度>
实现优先级调度
<a class=anchor href=#%e5%ae%9e%e7%8e%b0%e4%bc%98%e5%85%88%e7%ba%a7%e8%b0%83%e5%ba%a6>#</a>
</h4>
<p><strong>优先级调度概念：</strong></p>
<p>在原始的代码实现中，线程的就绪队列基本采用的是先来先服务（FCFS）的调度方式，即先进入就绪队列的线程在调度时会先获得 CPU，这个实验的目的是将这种调度策略改成优先级调度。即当一个线程被添加到就绪列表中，并且该线程的优先级高于当前正在运行的线程时，当前线程应该立即将处理器交付给新线程。类似地，当有多个线程正在等待锁、信号量或条件变量时，优先级最高的等待线程应该首先被唤醒。</p>
<p>在 Pintos 中，线程优先级范围为 0 到 63。 较低的数字对应较低的优先级，因此优先级 0 是最低优先级，优先级 63 是最高优先级。 线程创建时默认的优先级为 PRI_DEFAULT = 31。</p>
<p>在这一部分涉及的代码测试点主要有：</p>
<table>
<thead>
<tr>
<th>测试点名称</th>
<th>测试内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>alarm-priority</td>
<td>创建不同优先级的线程，看他们唤醒之后的调度是否符合优先级顺序。</td>
</tr>
<tr>
<td>priority-change</td>
<td>降低线程的优先级，观察设置之后优先级比它高的线程是否被立刻调度。</td>
</tr>
<tr>
<td>priority-sema</td>
<td>测试信号量唤醒时，是否会唤醒信号量等待队列中优先级最高的线程。</td>
</tr>
<tr>
<td>priority-condvar</td>
<td>测试条件变量唤醒时，是否会唤醒条件变量等待队列中优先级最高的线程。</td>
</tr>
</tbody>
</table>
<p><strong>注意点：</strong></p>
<p>在实现优先级调度的时候，不仅仅需要考虑线程的就绪队列，还要考虑信号量和条件变量的等待队列。</p>
<h4 id=实现优先级捐赠>
实现优先级捐赠
<a class=anchor href=#%e5%ae%9e%e7%8e%b0%e4%bc%98%e5%85%88%e7%ba%a7%e6%8d%90%e8%b5%a0>#</a>
</h4>
<p><strong>优先级捐赠概念：</strong></p>
<p>在本实验中，优先级捐赠主要是针对线程对于锁的获取的。例如：如果线程 H 拥有较高的优先级，线程 M 拥有中等的优先级，线程 L 拥有较低的优先级。此时若线程 H 正在等待 L 持有的锁, 且 M 一直在就绪队列之中，那么线程 H 将永远无法获得 CPU。因此，这个时候需要将 H 的优先级捐赠给 L。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>H        M        L
|                 ^
|                 |
└------------------
       申请锁
</code></pre></div><p><strong>注意点：</strong></p>
<ol>
<li>一个锁只能被单个线程持有，而一个线程却可以持有多个锁。当线程持有多个锁时，需要将线程的优先级设置为其被捐赠的优先级中最大的。</li>
<li>会出现递归捐赠的问题。例如当前存在一个高优先级线程 H，一个中优先级线程 M，一个低优先级线程 L。如果 H 正在申请 M 持有的锁，M 正在申请 L 持有的锁，那么 M 和 L 的优先级都需要被设置为 H 的优先级。</li>
</ol>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>  等待锁    等待锁
H   -&gt;   M   -&gt;   L
</code></pre></div><p>以下是这部分内容所涉及的测试点：</p>
<table>
<thead>
<tr>
<th>测试点名称</th>
<th>测试内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>priority-donate-one</td>
<td>提出优先级捐赠概念，用一个线程给另一个线程捐赠优先级，利用打印优先级和标答做对比来判断是否通过。</td>
</tr>
<tr>
<td>priority-donate-multiple</td>
<td>用两个线程给一个线程捐赠优先级，观察优先级恢复的时候是否符合预期的答案。</td>
</tr>
<tr>
<td>priority-donate-multiple2</td>
<td>测试线程在释放锁的瞬间，是否会被高优先级线程抢占。</td>
</tr>
<tr>
<td>priority-donate-nest</td>
<td>创建三个线程 A、B、C，先让 B 给 A 捐赠优先级，再让 C 给 B 捐赠优先级，观察 A 的优先级是否有改变。</td>
</tr>
<tr>
<td>priority-donate-sema</td>
<td>锁 + 优先级捐赠 + 信号量混合，之后说明测试过程。</td>
</tr>
<tr>
<td>priority-donate-lower</td>
<td>在优先级捐赠生效的情况下降低线程的优先级，希望是线程的优先级没有被改变，并在释放锁之后恢复到刚刚设置的优先级。</td>
</tr>
</tbody>
</table>
<h3 id=任务三高级调度>
任务三：高级调度
<a class=anchor href=#%e4%bb%bb%e5%8a%a1%e4%b8%89%e9%ab%98%e7%ba%a7%e8%b0%83%e5%ba%a6>#</a>
</h3>
<p>在优先级调度策略之中，高优先级的进程永远抢占着 CPU，而低优先级线程能获得的时间非常少。在本实验中，我们会实现更加复杂的调度器，该实验所实现的调度器会自动维护线程的优先级。同样的，在任何给定的时间，调度程序从最高优先级的非空队列中选择一个线程。本实验需要弄清楚以下几个概念：</p>
<ol>
<li><code>ready_threads</code>：代表当前正在处于运行态和就绪态的线程的数量。</li>
<li><code>load_avg</code>：代表对过去一秒钟内准备运行的线程的数量的估计，其初始值被设置为 0，每一秒（100 个 ticks），<code>load_avg</code> 会按照以下公式进行更新：<code>load_avg = 59/60 * load_avg + 1/60 * ready_threads</code>。</li>
<li><code>recent_cpu</code>：每一个线程都拥有的变量，反应该线程获得 cpu 的多少。每一个 ticks，正在运行的线程的 <code>recent_cpu</code> 会增加 1。每一秒(100 个 ticks)，所有的线程的 <code>recent_cpu</code> 会按照以下公式进行更新：<code>recent_cpu = (2 * load_avg) / (2 * load_avg + 1) * recent_cpu + nice</code>。</li>
<li><code>nice</code>：代表线程对其他线程的友好程度，取值范围为 0 到 20，<code>nice</code> 值为 0 不会影响该线程的优先级，nice 值越大，该线程对其他线程越友好，即该线程的优先级越低，线程创建时初始 nice 值为 0。</li>
<li><code>priority</code>：线程的优先级，每四个 ticks，线程的优先级应当按照以下公式进行更新：<code>priority = PRI_MAX - 1/4 * recent_cpu - 2 * nice</code>。</li>
</ol>
<p><strong>注意点：</strong></p>
<ol>
<li>在 Pintos 中，存在一个 <code>thread_mlfqs</code> 的布尔量控制高级调度，当其值为 <code>true</code> 时，使用高级调度，当值为 <code>false</code> 时，使用优先级调度。高级调度和优先级调度存在少部分冲突，需要特殊判断。</li>
<li>如果前两个任务实现的时间复杂度过高，会影响该任务的测试。</li>
<li>使用公式计算的优先级可能超出 Pintos 设定的优先级范围(0-63)</li>
<li>在本实验之前请各位确保已经阅读
<a href=http://web.stanford.edu/~ouster/cgi-bin/cs140-spring20/pintos/pintos_7.html#SEC131>任务三详细文档</a>，本实验中涉及到浮点运算的部分都需要使用该文档中所提及到的方法。</li>
</ol>
<p>任务三的测试样例如下：</p>
<table>
<thead>
<tr>
<th>测试点名称</th>
<th>测试内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>mlfqs-load-1</td>
<td>加载 1 个线程（主线程），运行一段时间后睡眠，检查 <code>load_avg</code> 有没有算对。</td>
</tr>
<tr>
<td>mlfqs-load-60</td>
<td>加载 60 个线程，同上，检查 <code>load_avg</code> 有没有算对。</td>
</tr>
<tr>
<td>mlfqs-load-avg</td>
<td>加载 60 个线程，并有一次唤醒和睡眠的行为，检查 <code>load_avg</code> 有没有算对。</td>
</tr>
<tr>
<td>mlfqs-recent-1</td>
<td>加载 1 个线程（主线程），睡眠一段时间后唤醒，检查 <code>recent_cpu</code> 有没有算对。</td>
</tr>
<tr>
<td>mlfqs-fair-2</td>
<td>运行 2 个<code>nice = 0</code>的线程，检查他们间运行时间的差距。</td>
</tr>
<tr>
<td>mlfqs-fair-20</td>
<td>运行 20 个<code>nice = 0</code> 的线程，检查他们间运行时间的差距。</td>
</tr>
<tr>
<td>mlfqs-nice-2</td>
<td>运行 1 个<code>nice = 0</code>和 1 个<code>nice = 5</code>的线程，共运行 3000 时间，检查他们的运行时长。</td>
</tr>
<tr>
<td>mlfqs-nice-10</td>
<td>运行 10 个<code>nice</code>为 0 ~ 9 的线程，共运行 3000 时间，检查他们的运行时长。</td>
</tr>
<tr>
<td>mlfqs-block</td>
<td>检查在 <code>mlfqs</code> 模式下优先级捐赠会不会改变线程优先级等级，正常下不改变。</td>
</tr>
</tbody>
</table>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
<div><a class="flex align-center" href=https://github.com/alex-shpak/hugo-book/commit/da699af9e45f9f344724eedcdcdf836e4681d222 title="Last modified by Yinghao Zhu | October 14, 2021" target=_blank rel=noopener>
<img src=/os-labs/svg/calendar.svg class=book-icon alt=Calendar>
<span>October 14, 2021</span>
</a>
</div>
<div>
<a class="flex align-center" href=https://github.com/alex-shpak/hugo-book/edit/main/exampleSite/content/docs/table-of-contents/p1.md target=_blank rel=noopener>
<img src=/os-labs/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span>
</a>
</div>
</div>
<script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>
</footer>
<div class=book-comments>
</div>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<div class=book-toc-content>
<nav id=TableOfContents>
<ul>
<li><a href=#project-1-threads>Project 1: Threads</a>
<ul>
<li><a href=#实验背景知识>实验背景知识</a>
<ul>
<li><a href=#pintos-简介>Pintos 简介</a></li>
<li><a href=#pintos-目录结构>Pintos 目录结构</a></li>
<li><a href=#实验运行方式>实验运行方式</a></li>
<li><a href=#常用文件介绍>常用文件介绍</a></li>
</ul>
</li>
<li><a href=#实验介绍>实验介绍</a>
<ul>
<li><a href=#任务一唤醒时钟>任务一：唤醒时钟</a></li>
<li><a href=#任务二优先级调度>任务二：优先级调度</a></li>
<li><a href=#任务三高级调度>任务三：高级调度</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
</main>
</body>
</html>